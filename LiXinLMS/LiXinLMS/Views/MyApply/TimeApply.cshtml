@{
    ViewBag.Title = "TimeApply";
    Layout = null;
}
<div class="tab-bk mt10">
    <ul id="tagTimeOutes">
        <li class="On" id="tagTimeOut0">全部</li>
        <li id="tagTimeOut1">已申请</li>
        <li id="tagTimeOut2">待申请</li>
    </ul>
</div>
<div id="div">
    <div class="so-set">
        <table class="tab-Form">
            <tr>
                <td class="Tit span4">姓名：
                </td>
                <td>
                    <input type="text" class="span10 Box searchclass" id="realname" value="请输入姓名" info="" />
                </td>
                <td class="so-do">
                    <input class="btn" type="button" value="搜索" id="btnSearch" onclick=" InitData(); " />
                </td>
            </tr>
        </table>
    </div>
    <div class="so-seq">
        <select id="selTrainGrade" onchange="InitData();">
            <option value="-1">培训级别</option>
        </select>
        <select id="sltTimeOut" onchange=" InitData(); ">
            <option value="99">申请状态</option>
            <option value="1">已申请</option>
            <option value="0">未申请</option>
        </select>
        <select id="sltStatus" onchange=" InitData(); ">
            <option value="99">审批状态</option>
            <option value="1">审批通过</option>
            <option value="2">审批拒绝</option>
            <option value="0">待审批</option>
            <option value="-1">——</option>
        </select>
    </div>
    <div class="mt10">
        <table class="tab-List">
            <thead>
                <tr>
                    <th class="span4">序号
                    </th>
                    <th class="span8">姓名
                    </th>
                    <th class="span8" jsrendersortfield="Sys_User.TrainGrade" sort="desc">培训级别
                    </th>
                    <th class="span12" jsrendersortfield="Cl_MakeUpOrder.LeaveTime" sort="desc">补预订时间
                    </th>
                    <th>课程名称
                    </th>
                    <th class="span6" jsrendersortfield="Co_Course.CourseLength" sort="desc">学时
                    </th>
                    <th class="span14" jsrendersortfield="Co_Course.StartTime" sort="desc">开课时间
                    </th>
                    <th class="span8">是否已申请
                    </th>
                    <th class="span8">审批状态
                    </th>
                    <th class="span8">操作
                    </th>
                </tr>
            </thead>
            <tbody id="courseList">
            </tbody>
            <tfoot>
            </tfoot>
        </table>
    </div>
</div>
<div id="div0" style="display: none;">
    <div class="so-set">
        <table class="tab-Form">
            <tr>
                <td class="Tit span4">姓名：
                </td>
                <td class="span11">
                    <input type="text" class="span10 Box searchclass" id="realname0" value="请输入姓名"
                        info="" />
                </td>
                <td class="Tit span7">课程名称：
                </td>
                <td>
                    <input type="text" class="span30 Box searchclass" id="course0" value="请输入课程名称" info="" />
                </td>
                <td class="so-do">
                    <input class="btn" type="button" value="搜索" id="btnSearch0" onclick=" InitData0(); " />
                </td>
            </tr>
        </table>
    </div>
    <div class="so-seq">
        <select id="selTrainGrade0" onchange="InitData0();">
            <option value="-1">培训级别</option>
        </select>
        <div class="list-do">
            <input type="button" value="批量申请" class="btn" onclick="ApplyMemoShow(GetChecked('courseList0'));" />
        </div>
    </div>
    <div class="mt10">
        <table class="tab-List">
            <thead>
                <tr>
                    <th class="span4">
                        <input type="checkbox" value="0" id="selectall0" />
                    </th>
                    <th class="span4">序号
                    </th>
                    <th class="span8">姓名
                    </th>
                    <th class="span8" jsrendersortfield="Sys_User.TrainGrade" sort="desc">培训级别
                    </th>
                    <th class="span12" jsrendersortfield="Cl_MakeUpOrder.LeaveTime" sort="desc">补预订时间
                    </th>
                    <th>课程名称
                    </th>
                    <th class="span6" jsrendersortfield="Co_Course.CourseLength" sort="desc">学时
                    </th>
                    <th class="span12" jsrendersortfield="Co_Course.StartTime" sort="desc">开课时间
                    </th>
                    <th class="span14" jsrendersortfield="Cl_MakeUpOrder.ApprovalLimitTime" sort="desc">补预订审批结束时间
                    </th>
                    <th class="span6">操作
                    </th>
                </tr>
            </thead>
            <tbody id="courseList0">
            </tbody>
            <tfoot>
            </tfoot>
        </table>
    </div>
</div>
<div id="div1" style="display: none;">
    <div class="so-set">
        <table class="tab-Form">
            <tr>
                <td class="Tit span4">姓名：
                </td>
                <td class="span11">
                    <input type="text" class="span10 Box searchclass" id="realname1" value="请输入姓名"
                        info="" />
                </td>
                <td class="Tit span7">课程名称：
                </td>
                <td>
                    <input type="text" class="span30 Box searchclass" id="course1" value="请输入课程名称" info="" />
                </td>
                <td class="so-do">
                    <input class="btn" type="button" value="搜索" id="btnSearch1" onclick=" InitData1(); " />
                </td>
            </tr>
        </table>
    </div>
    <div class="so-seq">
        <select id="selTrainGrade1" onchange="InitData1();">
            <option value="-1">培训级别</option>
        </select>
        <select id="sltStatus1" onchange=" InitData1(); ">
            <option value="99">审批状态</option>
            <option value="1">审批通过</option>
            <option value="2">审批拒绝</option>
            <option value="0">待审批</option>
        </select>
    </div>
    <div class="mt10">
        <table class="tab-List">
            <thead>
                <tr>
                    <th class="span4">序号
                    </th>
                    <th class="span8">姓名
                    </th>
                    <th class="span8" jsrendersortfield="Sys_User.TrainGrade" sort="desc">培训级别
                    </th>
                    <th class="span12" jsrendersortfield="Cl_MakeUpOrder.LeaveTime" sort="desc">补预订时间
                    </th>
                    <th>课程名称
                    </th>
                    <th class="span8" jsrendersortfield="Co_Course.CourseLength" sort="desc">学时
                    </th>
                    <th class="span12" jsrendersortfield="Co_Course.StartTime" sort="desc">开课时间
                    </th>
                    <th class="span8">审批状态
                    </th>
                </tr>
            </thead>
            <tbody id="courseList1">
            </tbody>
            <tfoot>
            </tfoot>
        </table>
    </div>
</div>

<script id="courseListTemplate" type="text/x-jsrender">
    {{for #data}}
    <tr>
        <td>{{:#index+1}}</td>
        <td>{{:RealName}}</td> 
        <td>{{:TrainGrade}}</td> 
        <td><div class="f11">{{:TimeOutApplyTime}}</div></td> 
        <td><div class="ovh span22 tl" title="{{:Course_Name}}">{{:Course_Name}}</div></td>   
        <td>{{:CourseLength}}</td> 
        <td><div class="f11 tl">{{:CourseTime}}</div></td> 
        <td>{{:IsTimeOut}}</td> 
        <td>{{:ApprovalStatus}}</td> 
        <td>
            {{if IsTimeOut == "否"}}
                <a onclick="ApplyMemoShow({{:Id}});" title="申请" class="icon iapply"></a>
            {{else}}
                <span class="icon iapply idis" title="申请"></span>
            {{/if}}
            <a class="icon iview" onclick="ViewDetail({{:Id}});" title="查看详情"></a>
        </td> 
    </tr> 
    {{/for}}
</script>
<script id="courseListTemplate0" type="text/x-jsrender">
    {{for #data}}
    <tr>
        <td><input type="checkbox" id='{{:Id}}' value='{{:Id}}' /></td>
        <td>{{:#index+1}}</td>
        <td>{{:RealName}}</td> 
        <td>{{:TrainGrade}}</td> 
        <td><div class="f11">{{:TimeOutApplyTime}}</div></td> 
        <td><div class="ovh span24 tl" title="{{:Course_Name}}">{{:Course_Name}}</div></td>   
        <td>{{:CourseLength}}</td> 
        <td><div class="tl f11">{{:CourseTime}}</div></td> 
        <td><div class="f11">{{:ApprovalLimitTime}}</div></td>
        <td>
            <a onclick="ApplyMemoShow({{:Id}});" title="申请" class="icon iapply"></a>
        </td>
    </tr> 
    {{/for}}
</script>
<script id="courseListTemplate1" type="text/x-jsrender">
    {{for #data}}
    <tr>
        <td>{{:#index+1}}</td>
        <td>{{:RealName}}</td> 
        <td>{{:TrainGrade}}</td> 
        <td><div class="f11">{{:TimeOutApplyTime}}</div></td> 
        <td><div class="ovh span38 tl" title="{{:Course_Name}}">{{:Course_Name}}</div></td>   
        <td>{{:CourseLength}}</td> 
        <td><div class="f11 tl">{{:CourseTime}}</div></td> 
        <td>{{:ApprovalStatus}}</td> 
    </tr> 
    {{/for}}
</script>
<script type="text/javascript">
    var flag = 99;
    $(document).ready(function ()
    {

        //初始化查询条件
        initSearch();
        //加载培训级别
        $.getJSON("/MyApproval/GetTrainGrade", function (data)
        {
            for (var i = 0; i < data.length; i++)
            {
                $("#selTrainGrade,#selTrainGrade0,#selTrainGrade1").append('<option value="' + data[i] + '">' + data[i] + '</option>');
            }
        });


        $("#div").show();
        $("#div0").hide();
        $("#div1").hide();
        InitData();
        $("#tagTimeOutes li").click(function ()
        {
            $("#tagTimeOutes li").removeClass("On");
            $(this).addClass("On");
            $("#div").hide();
            $("#div0").hide();
            $("#div1").hide();
            var index = $(this).index();
            if (index == 0)
            {
                flag = 99;
                InitData();
                $("#div").show();
            }
            else if (index == 1)
            {
                flag = 1;
                InitData1();
                $("#div1").show();
            }
            else if (index == 2)
            {
                flag = 0;
                InitData0();
                $("#div0").show();
            }
        });
    });

    function InitData()
    {
        var trainGrade = $("#selTrainGrade").val() == '-1' ? "" : $("#selTrainGrade").val();
        var timeout = flag;
        if (timeout == 99)
        {
            timeout = $("#sltTimeOut").val();
        }
        var v = "realname=" + escape(getSearchWord("realname")) + "&timeout=" + timeout + "&approval=" + $("#sltStatus").val() + "&traingrade=" + trainGrade;
        $("#courseList").JsRenderData({
            sourceUrl: '/MyApply/GetTimeOutApplyList?' + v,
            isPage: true,
            pageSize: 10,
            pageIndex: 1,
            jsRenderSortField: "Co_Course.Id",
            jsRenderASC: "desc",
            templateID: "courseListTemplate",
            funCallback: function ()
            {
            }
        });
    }

    function InitData0()
    {
        var trainGrade = $("#selTrainGrade0").val() == '-1' ? "" : $("#selTrainGrade0").val();
        var v = "realname=" + escape(getSearchWord("realname0")) + "&timeout=" + flag + "&traingrade=" + trainGrade + "&course=" + escape(getSearchWord("course0"));
        $("#courseList0").JsRenderData({
            sourceUrl: '/MyApply/GetTimeOutApplyList?' + v,
            isPage: true,
            pageSize: 10,
            pageIndex: 1,
            jsRenderSortField: "Co_Course.Id",
            jsRenderASC: "desc",
            templateID: "courseListTemplate0",
            funCallback: function ()
            {
                SetCheckBox('selectall0', 'courseList0');
            }
        });
    }

    function InitData1()
    {
        var trainGrade = $("#selTrainGrade1").val() == '-1' ? "" : $("#selTrainGrade1").val();
        var v = "realname=" + escape(getSearchWord("realname1")) + "&timeout=" + flag + "&traingrade=" + trainGrade + "&course=" + escape(getSearchWord("course1")) + "&approval=" + $("#sltStatus1").val();
        $("#courseList1").JsRenderData({
            sourceUrl: '/MyApply/GetTimeOutApplyList?' + v,
            isPage: true,
            pageSize: 10,
            pageIndex: 1,
            jsRenderSortField: "Co_Course.Id",
            jsRenderASC: "desc",
            templateID: "courseListTemplate1",
            funCallback: function ()
            {
            }
        });
    }

    function Apply(ids)
    {
        var str = $("#txtApplyMemo").val();
        if ($.trim(str) == "")
        {
            art.dialog.tips("申请理由不能为空！", 3);
        } else
        {
            $.post("/MyApply/SubmitTimeOutApply/", { ids: ids, applymemo: str }, function (da)
            {
                if (da.result == 1)
                {
                    closeDialog("art_Apply");
                    art.dialog.tips(da.content, 3);
                    if (flag == 99)
                    {
                        InitData();
                    } else
                    {
                        InitData0();
                    }
                } else
                {
                    art.dialog.tips(da.content, 3);
                }
            });
        }
    }

    function ApplyMemoShow(ids)
    {
        if (ids == "" || ids == undefined)
        {
            art.dialog.tips("请选择要逾时审批申请的数据！", 3);
        } else
        {
            var div = '<div id="div_Apply">'
                      + '     <table class="tab-Form mt20">'
                      + '        <tr>'
                      + '            <td class="Tit span8">'
                      + '                 <span class="must">*</span>申请理由：'
                      + '            </td>'
                      + '            <td>'
                      + '                  <textarea id="txtApplyMemo" cols="20" rows="2" class="span30"></textarea>'
                      + '            </td>'
                      + '        </tr>'
                      + '     </table>'
                      + '     <div class="tc mt10">'
                      + '        <input type="button" class="btn" onclick="Apply(\'' + ids + '\');" value="提交" />'
                      + '    </div>'
                      + '</div>';
            art.dialog({
                content: div,
                title: '逾时审批申请',
                id: 'art_Apply',
                height: 250,
                width: 500,
                init: function ()
                {
                    $("#txtApplyMemo").textareaCount({ maxCharacterSize: 500 });
                }
            });
        }
    }

    function ViewDetail(id)
    {
        window.location.href = "/MyApply/TimeOutApplyDetail/" + id;
    }
</script>
